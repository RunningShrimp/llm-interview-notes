<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>{{ page.title | default: site.title }}</title>
    
    <!-- SEO and Metadata -->
    <meta name="description" content="{{ page.description | default: site.description }}">
    <meta name="author" content="{{ page.author | default: site.author }}">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
    <link rel="stylesheet" href="{{ '/assets/css/toc.css' | relative_url }}">
    
    {% if page.custom_css %}
        <link rel="stylesheet" href="{{ page.custom_css | relative_url }}">
    {% endif %}
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-to-main">Skip to main content</a>
    
    <!-- Header Navigation -->
    <header class="site-header" role="banner">
        <div class="container">
            <div class="header-content">
                <a href="{{ '/' | relative_url }}" class="site-logo">
                    {{ site.title }}
                </a>
                <nav class="site-nav" role="navigation" aria-label="Main navigation">
                    <ul>
                        {% for nav_item in site.navigation %}
                            <li>
                                <a href="{{ nav_item.url | relative_url }}" 
                                   {% if page.url == nav_item.url %}aria-current="page"{% endif %}>
                                    {{ nav_item.title }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Layout Container -->
    <div class="layout-container">
        <!-- Table of Contents Sidebar -->
        <aside class="toc-sidebar" id="toc-sidebar" role="complementary" aria-label="Table of Contents">
            <div class="toc-wrapper">
                <div class="toc-header">
                    <h2 class="toc-title">Contents</h2>
                    <button class="toc-toggle" id="toc-toggle" aria-expanded="true" aria-controls="toc-list">
                        <span class="sr-only">Toggle table of contents</span>
                        <svg class="toc-toggle-icon" viewBox="0 0 24 24" width="20" height="20">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
                
                <nav class="toc-nav" id="toc-list" role="navigation" aria-label="Page table of contents">
                    <ol class="toc-list" id="toc-content">
                        <!-- Table of Contents will be generated here by JavaScript -->
                    </ol>
                </nav>
                
                <div class="toc-footer">
                    {% if page.last_modified_date %}
                        <div class="last-updated">
                            <small>Last updated: <time datetime="{{ page.last_modified_date | date_to_xmlschema }}">
                                {{ page.last_modified_date | date: "%B %d, %Y" }}
                            </time></small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="main-content" role="main">
            <article class="page-content">
                <!-- Page Header -->
                <header class="page-header">
                    <h1 class="page-title">{{ page.title }}</h1>
                    
                    {% if page.subtitle %}
                        <p class="page-subtitle">{{ page.subtitle }}</p>
                    {% endif %}
                    
                    {% if page.date or page.author %}
                        <div class="page-meta">
                            {% if page.author %}
                                <span class="meta-item">
                                    By <span class="author" itemprop="author">{{ page.author }}</span>
                                </span>
                            {% endif %}
                            
                            {% if page.date %}
                                <span class="meta-item">
                                    <time datetime="{{ page.date | date_to_xmlschema }}" itemprop="datePublished">
                                        {{ page.date | date: "%B %d, %Y" }}
                                    </time>
                                </span>
                            {% endif %}
                        </div>
                    {% endif %}
                </header>

                <!-- Main Page Content -->
                <div class="page-body">
                    {{ content }}
                </div>

                <!-- Page Footer -->
                {% if page.tags %}
                    <footer class="page-footer">
                        <div class="tags">
                            <span class="tags-label">Tags:</span>
                            {% for tag in page.tags %}
                                <a href="{{ '/tags/' | relative_url }}#{{ tag | slugify }}" class="tag">
                                    {{ tag }}
                                </a>
                            {% endfor %}
                        </div>
                    </footer>
                {% endif %}
            </article>

            <!-- Navigation to other pages -->
            {% if page.previous or page.next %}
                <nav class="page-navigation" aria-label="Page navigation">
                    <ul class="nav-list">
                        {% if page.previous %}
                            <li class="nav-item nav-prev">
                                <a href="{{ page.previous.url | relative_url }}" rel="prev">
                                    <span class="nav-direction">← Previous</span>
                                    <span class="nav-title">{{ page.previous.title }}</span>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% if page.next %}
                            <li class="nav-item nav-next">
                                <a href="{{ page.next.url | relative_url }}" rel="next">
                                    <span class="nav-direction">Next →</span>
                                    <span class="nav-title">{{ page.next.title }}</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </main>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <p>&copy; {{ site.time | date: '%Y' }} {{ site.author }}. All rights reserved.</p>
                <nav class="footer-nav" aria-label="Footer navigation">
                    <ul>
                        {% for nav_item in site.footer_navigation %}
                            <li>
                                <a href="{{ nav_item.url | relative_url }}">
                                    {{ nav_item.title }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </nav>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="{{ '/assets/js/table-of-contents.js' | relative_url }}"></script>
    
    {% if page.custom_js %}
        <script src="{{ page.custom_js | relative_url }}"></script>
    {% endif %}

    <!-- Table of Contents Initialization -->
    <script>
        /**
         * Initialize the Table of Contents Handler
         * Runs when the DOM is fully loaded to ensure all content is available
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize TableOfContents with configuration
            if (typeof TableOfContents !== 'undefined') {
                const tocHandler = new TableOfContents({
                    // Container where TOC content will be generated
                    container: document.getElementById('toc-content'),
                    
                    // Main content area to scan for headings
                    contentSelector: '.page-body',
                    
                    // Heading levels to include (h2-h4)
                    headingLevels: ['H2', 'H3', 'H4'],
                    
                    // Enable smooth scrolling
                    smoothScroll: true,
                    
                    // Update TOC on window scroll
                    activeTracking: true,
                    
                    // Custom heading ID prefix
                    idPrefix: 'heading-',
                    
                    // Callback when TOC is generated
                    onGenerate: function(toc) {
                        console.log('Table of Contents generated successfully');
                    },
                    
                    // Callback for errors
                    onError: function(error) {
                        console.error('Table of Contents error:', error);
                    }
                });

                // Optional: Initialize toggle functionality for TOC sidebar
                const tocToggle = document.getElementById('toc-toggle');
                const tocList = document.getElementById('toc-list');
                
                if (tocToggle && tocList) {
                    tocToggle.addEventListener('click', function() {
                        const isExpanded = this.getAttribute('aria-expanded') === 'true';
                        this.setAttribute('aria-expanded', !isExpanded);
                        tocList.setAttribute('aria-hidden', isExpanded);
                        
                        // Add animation class if CSS transitions are desired
                        tocList.classList.toggle('collapsed');
                    });
                }

                // Handle window resize to update TOC positioning
                let resizeTimer;
                window.addEventListener('resize', function() {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(function() {
                        if (tocHandler.update) {
                            tocHandler.update();
                        }
                    }, 250);
                });
            } else {
                console.warn('TableOfContents class not found. Ensure table-of-contents.js is loaded.');
            }
        });

        /**
         * Accessibility Enhancement: Add focus indicators for keyboard navigation
         */
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-focus');
            }
        });
        
        document.addEventListener('mousedown', function() {
            document.body.classList.remove('keyboard-focus');
        });
    </script>

    {% if page.mathjax %}
        <!-- MathJax for LaTeX rendering -->
        <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    {% endif %}

    {% if page.highlight_code %}
        <!-- Code highlighting -->
        <script src="{{ '/assets/js/highlight.js' | relative_url }}"></script>
    {% endif %}
</body>
</html>
